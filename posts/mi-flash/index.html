<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>刷机 - Be a producer not a consumer</title><meta property="og:title" content="刷机 - Be a producer not a consumer"><link rel="shortcut icon" href=https://lonnyzhang423.github.io//favicon.ico><link rel=stylesheet href=https://lonnyzhang423.github.io/css/main.css type=text/css><link rel=stylesheet href=https://lonnyzhang423.github.io/css/prism.css type=text/css><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MGVBB6PZQ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-1MGVBB6PZQ');</script></head><body><div class=wrapper><header class=header><nav class=nav><a href=https://lonnyzhang423.github.io/ class=nav-logo></a><ul class=nav-links><li><a href=https://lonnyzhang423.github.io/>首页</a></li><li><a href=https://github.com/lonnyzhang423>GitHub</a></li><li><a href=https://twitter.com/lonnyzhang423>Twitter</a></li><li><a href=/about>关于</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>刷机</h1><span class=article-date>2021-09-15</span><div class=article-content><h2 id=背景>背景</h2><p>对第三方 app 进行抓包</p><h2 id=方案>方案</h2><ol><li><p><a href=https://github.com/android-hacker/VirtualXposed>VirtualXposed</a></p><ul><li>无需 root</li><li>兼容性差、限制运行、崩溃等</li></ul></li><li><p>Charles</p><ul><li>Android7.0 以前：无需 root，把 Charles 证书导入到用户证书目录即可抓包。</li><li>Android7.0 及更高版本：系统不再信任用户证书，虽然可在 Manifest 中指定信任用户证书，但需要对每个 apk 进行反编译、修改、打包</li></ul></li></ol><p>刚好手里有台闲置的小米 6，选择方案 2，把 Charles 证书导入系统证书目录就没有高版本的证书限制了，刷机搞起。</p><h2 id=刷机步骤>刷机步骤</h2><ol><li><p>解锁 BootLoader</p><p>需要使用小米账号，按要求申请解锁 BL 权限，<a href=https://www.miui.com/unlock/index.html>申请链接</a>。</p><p>注意：每个小米账号一月内只能解锁 1 台设备，一年最多解锁 4 台设备</p></li><li><p>下载开发版线刷包</p><p>19 年开始小米不再提供开发版下载地址，需要申请内测来刷开发版。不过有网站记录了开发版的镜像地址，<a href=https://roms.miuier.com/devices/sagit>链接地址</a>，选择指定<a href=http://bigota.d.miui.com/9.9.3/sagit_images_9.9.3_20190904.0000.00_9.0_cn_b51d5ce3d8.tgz>版本</a>，下载并解压到本地。</p></li><li><p>下载工具开始刷机</p><p>下载工具，按说明使用。<a href=http://bigota.d.miui.com/tools/MiFlash2018-5-28-0.zip>下载地址</a></p></li><li><p>开启 root</p><p>刷机完成后，依次打开手机管家&mdash;应用管理&mdash;权限管理&mdash;开启 root</p></li><li><p>导入证书</p><p>导出 Charles 证书 <code>charles.pem</code>，使用 <code>openssl</code> 命令查看证书 hash，</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ openssl x509 -inform PEM -subject_hash_old -in charles.pem
</code></pre></div><p>保存上一行命令生成的 hash(假设为 1984orwell)，把证书导入系统证书目录并重命名为 1984orwell.0</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ adb root
$ adb remount
$ adb push charles.pem /system/etc/security/cacerts/1984orwell.0
</code></pre></div></li></ol><h2 id=完成>完成</h2><p>Done，可以愉快的抓包了。</p></div></article><div id=gitalk-container></div><link rel=stylesheet href=https://unpkg.com/gitalk/dist/gitalk.css><script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script><script>const gitalk=new Gitalk({clientID:'5d9c5d2034f7da8d1660',clientSecret:'00657b04241c1849eff4c31aa21ca988a3499699',repo:'lonnyzhang423.github.io',owner:'lonnyzhang423',admin:['lonnyzhang423'],id:location.pathname,title:document.title,labels:['Gitalk'],perPage:20,pagerDirection:'last',distractionFreeMode:false,createIssueManually:false,});gitalk.render('gitalk-container');</script></main><footer class=footer><ul class=footer-links><li><a href=https://gohugo.io/>Powered by Hugo</a></li></ul></footer></div><script src=https://lonnyzhang423.github.io/js/prism.js></script></body></html>