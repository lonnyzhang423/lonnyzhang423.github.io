<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Go值接收器和引用接收器对比 - Be a producer not a consumer</title><meta property="og:title" content="Go值接收器和引用接收器对比 - Be a producer not a consumer"><link rel="shortcut icon" href=https://lonnyzhang423.github.io//favicon.ico><meta name=google-site-verification content="mrmYxen0H36dGkSLftvdiFtjhoR5upZFMOAh-HDoDkc"><link rel=stylesheet href=https://lonnyzhang423.github.io/css/main.css type=text/css><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MGVBB6PZQ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-1MGVBB6PZQ');</script><link rel=stylesheet href=https://lonnyzhang423.github.io/css/prism.css type=text/css><script src=https://lonnyzhang423.github.io/js/prism.js></script></head><body class=line-numbers><div class=wrapper><header class=header><nav class=nav><a href=https://lonnyzhang423.github.io/ class=nav-logo></a><ul class=nav-links><li><a href=/>首页</a></li><li><a href=/tags>标签</a></li><li><a href=/about>关于</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>Go值接收器和引用接收器对比</h1><span class=article-date>2021-11-05</span>
<a class=article-tag href=https://lonnyzhang423.github.io/tags/go/>go</a><div class=article-content><h2 id=实现方法时如何选择接收器类型>实现方法时，如何选择接收器类型</h2><p>在给结构体添加方法时，需要确定接收器类型，有两种选择：值或引用。<br>下面总结下这两种类型的区别和适用场景。</p><h3 id=值接收器>值接收器</h3><ul><li>总是传递拷贝，对拷贝的修改不会影响到原始的值</li><li>需要拷贝，当对象比较大时，性能会有所影响</li><li>生命周期和方法的调用周期相同，调用结束后，值接收器就会被销毁</li><li>分配在栈上，不会逃逸到堆上，对 gc 的影响更小</li><li>没有并发问题，可以在多个 goroutine 中使用</li></ul><h3 id=引用接收器>引用接收器</h3><ul><li>总是传递指针，对指针的修改会影响到原始的值</li><li>不需要拷贝对象，当对象比较大时性能更好</li><li>会“逃逸”到堆上，对 gc 的影响更大</li><li>默认值是 <code>nil</code> ，使用时需要显式的判断</li><li>相对于值接收器，指针的 <code>nil</code> 可用来标识对象不存在或已经被销毁<br>例如，现在有如下结构体：<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Form</span> <span style=color:#66d9ef>struct</span> {
  <span style=color:#a6e22e>ID</span> <span style=color:#66d9ef>int</span> <span style=color:#e6db74>`json:&#34;id&#34;`</span>
  <span style=color:#a6e22e>IsOk</span> <span style=color:#66d9ef>bool</span> <span style=color:#e6db74>`json:&#34;is_ok&#34;`</span>
}
</code></pre></div><p>现在要修改这个 Form 的某些值，前端在做逻辑的时候只会向后端提交有修改的字段。因为 go 的 bool 默认值是 <code>false</code> ，此时是区分不了是默认值还是前端传过来的值的，把 <code>IsOK</code> 字段改为 <code>*bool</code> 类型，就可以解决这个问题。</p></li><li>需要考虑并发访问的场景，可能会出现并发问题</li></ul><h3 id=总结>总结</h3><p>根据 go 官方的建议<sup><a href=https://github.com/golang/go/wiki/CodeReviewComments#receiver-type>1</a></sup>，总结如下:</p><ul><li>优先<strong>使用引用接收器</strong></li><li>如果对象是 map、chan 或者 func，<strong>不使用引用接收器</strong></li><li>如果对象是 slice，方法中没有 reslice 或 reallocate 操作，<strong>不使用引用接收器</strong></li><li>如果方法需要改变对象，<strong>必须使用引用接收器</strong></li><li>如果对象包含 <code>sync.Mutex</code> 或类似的同步字段，<strong>不使用引用接收器</strong></li><li>如果对象是大的结构体或大数组，为了避免复制，<strong>使用引用接收器</strong></li><li>如果外部的修改需要在方法内可见，<strong>使用引用接收器</strong></li><li>如果对象是结构体、数组或 slice，且对象的元素也是指针，可能会被改变，为了让调用者更清楚对象的元素是可变的，<strong>使用引用接收器</strong></li><li>如果对象是小数组、简单的结构体或基本类型，<strong>使用值接收器</strong></li><li>不要混用两种类型。为了 api 的一致性，<strong>只使用一种接收器的类型</strong></li></ul><h3 id=参考>参考</h3><ol><li><a href=https://github.com/golang/go/wiki/CodeReviewComments#receiver-type>CodeReviewComments</a></li><li><a href=https://stackoverflow.com/questions/23542989/pointers-vs-values-in-parameters-and-return-values>pointers-vs-values-in-parameters-and-return-values</a></li></ol></div></article><div id=gitalk-container></div><link rel=stylesheet href=https://unpkg.com/gitalk/dist/gitalk.css><script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script><script>const gitalk=new Gitalk({clientID:'5d9c5d2034f7da8d1660',clientSecret:'00657b04241c1849eff4c31aa21ca988a3499699',repo:'lonnyzhang423.github.io',owner:'lonnyzhang423',admin:['lonnyzhang423'],id:location.pathname,title:document.title,labels:['Gitalk'],perPage:20,pagerDirection:'last',distractionFreeMode:false,createIssueManually:false,});gitalk.render('gitalk-container');</script></main><footer class=footer><ul class=footer-links><li><a href=https://gohugo.io/>Powered by Hugo</a></li></ul></footer></div></body></html>